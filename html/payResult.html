<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>支付结果</title>
    <link rel="stylesheet" type="text/css" href="../lib/css/weui.min.css" />
    <link rel="stylesheet" type="text/css" href="../lib/css/jquery-weui.css" />
    <link rel="stylesheet" type="text/css" href="../custom/css/common.css" />
    <link rel="stylesheet" type="text/css" href="../custom/css/manage.css" />

</head>

<body>
    <div class="container manageContainer">
        <div class="no-data-box" style="display:none;" id="success">
            <div class="custom-nodata">
                <img src="../custom/images/order/success.png" style="width:3.293333rem;height: 2.88rem;">
                <p class="largeTxt">支付成功~</p>
            </div>
            <div class="btn-box">
                <span id="toIndex">返回首页</span><span id="orderDetail">查看订单</span>
            </div>
        </div>
        <div class="no-data-box" style="display:none;" id="fail">
            <div class="custom-nodata">
                <img src="../custom/images/order/fail.png" style="width:3.293333rem;height: 2.706667rem;">
                <p class="largeTxt">支付失败</p>
            </div>
            <div class="btn-box">
                <span class="repay">重新支付</span>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="../lib/js/flexible.js"></script>
    <script type="text/javascript" src="../lib/js/fastclick.min.js"></script>
    <script type="text/javascript" src="../lib/js/jquery.min.js"></script>
    <script src="../lib/js/jquery-weui.js"></script>
    <script type="text/javascript" src="../custom/js/native.js"></script>
    <script type="text/javascript" src="../custom/js/common.js?v=2019042601"></script>
    <script src="../custom/js/myTips.js?v=2019042601"></script>
    <script src="../custom/js/api.js?v=2019042601"></script>
    <script>
        $(function () {
            //click事件优化
            FastClick.attach(document.body);

            var netToken = localStorage.getItem('netToken');
            var requestUrl = localStorage.getItem('requestUrl');
            var channelCode = localStorage.getItem('channelCode');
            var lightAppCode = localStorage.getItem('lightAppCode');
            var shopUserId = localStorage.getItem('shopUserId');
            var isNative=localStorage.getItem('isNative');
            //支付相关url前段
            var paymentRequestUrl=localStorage.getItem('paymentRequestUrl');

            var orderId = localStorage.getItem("orderId");//订单id
            var paymentNo = getParams("out_trade_no");//支付单id

            // var payBusinessNo=localStorage.setItem("payBusinessNo");//商户号
            showMyloading();
            try {
                $.ajax({
                    // url: ajaxUrl.payAgentQueryPayStatus,
                    url: ajaxUrl.payAgentPayNotifyStatus,
                    type: "post",
                    contentType: 'application/json',
                    beforeSend: function (request) {
                        request.setRequestHeader("token", netToken);
                        request.setRequestHeader("channelCode", channelCode);
                        request.setRequestHeader("lightAppCode", lightAppCode);
                        request.setRequestHeader('timestamp', new Date().getTime());
                    },
                    data: JSON.stringify({
                        "paymentNo":paymentNo
                        // "biz_id": payBusinessNo,
                        // "business_no": orderId,
                        // "uid": localStorage.getItem('jkyUid'),
                    }),
                    success: function (firstData) {
                        if (firstData.code == 0) {
                            if (firstData.data.status == 1) {
                                $("#success").show();
                                //跳首页
                                $(document).on('click', '#toIndex', function () {
                                    if(isNative==1){
                                        //回到第一个webview
                                        //是否是商城(配在底部tab)
                                        var index;
                                        if(/healthcloud-shop-h5/.test(firstData.data.orderItemUrl)){
                                            index=-9;
                                        }else{
                                            index=-1;
                                        }
                                        NativeFunc({
                                            ACTION: 'CLOSEPAGE',
                                            PARAM: {
                                                INDEX: index
                                            }
                                        });
                                    }else {
                                        if(!localStorage.getItem("indexUrl")){
                                            NativeFunc({
                                                ACTION: "OPENURL",
                                                PARAM: {
                                                    URL: requestUrl +"/index.html?noFirst=1&forbidden=1"
                                                }
                                            })
                                        }else{
                                            NativeFunc({
                                                ACTION: "OPENURL",
                                                PARAM: {
                                                    URL: localStorage.getItem("indexUrl") + "&noFirst=1"
                                                }
                                            })
                                        }
                                    }
                                });
                                //查看订单
                                $(document).on('click', '#orderDetail', function () {
                                    var that = this;
                                    //是否是商城
                                    var detailParam;
                                    if(/healthcloud-shop-h5/.test(firstData.data.orderItemUrl)){
                                        detailParam="orderId";
                                    }else{
                                        detailParam="pay_code";
                                    }
									// 延迟跳转订单页面 防止由于网络延时导致后台未更新订单状态
									showMyloading();
									setTimeout(function() {
										hideMyloading();
										NativeFunc({
										    ACTION: "OPENURL",
										    PARAM: {
										        URL: firstData.data.orderItemUrl+"?"+detailParam+"=" + localStorage.getItem(detailParam)+"&v="+new Date().getTime()
										    }
										})
									}, 2500)
                                });
                            } else{
                                $("#fail").show();
                                //重新支付
                                $(document).on('click', '.repay', function () {
                                    var that = this;
                                    NativeFunc({
                                        ACTION: "OPENURL",
                                        PARAM: {
                                            URL: paymentRequestUrl + "/orderPay.html?forPage=2&orderId=" + localStorage.getItem("orderId") + "&paymentNo=" + paymentNo + "&totalFee=" + localStorage.getItem("amount")
                                        }
                                    })
                                });
                            }
                            hideMyloading();
                        }else {
                            requestWrongCode(firstData.code, firstData.msg);
                            hideMyloading();
                        }
                    },
                    error: function (error) {
                        hideMyloading();
                        console.log(error)
                        showMyTip();
                    }
                })
            } catch (e) {
                hideMyloading();
                showMyTip();
                console.log(e);
            }

        })  
    </script>

</body>

</html>