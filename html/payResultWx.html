<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>支付结果</title>
    <link rel="stylesheet" type="text/css" href="../lib/css/weui.min.css" />
    <link rel="stylesheet" type="text/css" href="../lib/css/jquery-weui.css" />
    <link rel="stylesheet" type="text/css" href="../custom/css/common.css" />
    <link rel="stylesheet" type="text/css" href="../custom/css/manage.css" />

</head>

<body>
    <div class="popup-wrap" style="display:block;">
        <div class="lightbox"></div>
        <div class="popup-con popup-con-middle">
            <!--<span class="close"></span>-->
            <p class="popup-txt">请确认微信支付是否已完成？</p>
            <div class="popup-btmbtn"><span class="preRepay">重新支付</span><span class="ok">支付已完成</span></div>
        </div>
    </div>
    <div class="container manageContainer">
        <div class="no-data-box" id="ask">
            <div class="custom-nodata">
                <img src="../custom/images/order/success.png" style="width:3.293333rem;height: 2.88rem;">
            </div>
        </div>
        <div class="no-data-box" style="display:none;" id="success">
            <div class="custom-nodata">
                <img src="../custom/images/order/success.png" style="width:3.293333rem;height: 2.88rem;">
                <p class="largeTxt">支付成功~</p>
            </div>
            <div class="btn-box">
                <span id="toIndex">返回首页</span><span id="orderDetail">查看订单</span>
            </div>
        </div>
        <div class="no-data-box" style="display:none;" id="fail">
            <div class="custom-nodata">
                <img src="../custom/images/order/fail.png" style="width:3.293333rem;height: 2.706667rem;">
                <p class="largeTxt">支付失败</p>
            </div>
            <div class="btn-box">
                <span class="repay">重新支付</span>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="../lib/js/flexible.js"></script>
    <script type="text/javascript" src="../lib/js/fastclick.min.js"></script>
    <script type="text/javascript" src="../lib/js/jquery.min.js"></script>
    <script src="../lib/js/jquery-weui.js"></script>
    <script type="text/javascript" src="../custom/js/native.js?v=2.0"></script>
    <script type="text/javascript" src="../custom/js/common.js?v=2.0"></script>
    <script src="../custom/js/myTips.js?v=2019042601"></script>
    <script src="../custom/js/api.js?v=2019042601"></script>
    <script>
        var pageData = {
            netToken: localStorage.getItem('netToken'),
            requestUrl: getParams("requestUrl") || localStorage.getItem('requestUrl'),
            channelCode: getParams("channelCode") || localStorage.getItem('channelCode'),
            lightAppCode: getParams("lightAppCode") || localStorage.getItem('lightAppCode'),
            isNative: getParams("isNative") || localStorage.getItem('isNative'),
            indexUrl: localStorage.getItem('indexUrl'),
            paymentRequestUrl:localStorage.getItem('paymentRequestUrl'),
            orderId:localStorage.getItem("orderId"),//订单id
            paymentNo:getParams("order_no") || getParams("payment_no"),//以微信带入的为准
            amount:localStorage.getItem("amount"),
        }

        $(function () {
            //click事件优化
            FastClick.attach(document.body);

            $(".ok").on("click", function () {
                getResult();
            })
            $(".preRepay").on("click", function () {
                try {
                    custom.ajaxRequest({
                        url: ajaxUrl.payAgentPayNotifyStatus,
                        type: "POST",
                        data: JSON.stringify({"paymentNo":pageData.paymentNo}),
                        error: function (error) {
                            hideMyloading();
                            console.log(error)
                            showMyTip();
                        }
                    },function (firstData) {
                        if (firstData.code == 0) {
                            if (firstData.data.status == 1) {
                                $(".mytip").html("您已支付成功,请勿重复支付");
                                showMyTip();
                                setTimeout(function () {
                                    $(".popup-wrap").hide();
                                    $("#ask").hide();
                                    $("#success").show();
                                    //跳首页
                                    $(document).on('click', '#toIndex', function () {
                                        if(pageData.isNative=='1'){
                                            //回到第一个webview
                                            //是否是商城(配在底部tab)
                                            var index;
                                            if(/healthcloud-shop-h5/.test(firstData.data.orderItemUrl)){
                                                index=-9;
                                            }else{
                                                index=-1;
                                            }
                                            NativeFunc({
                                                ACTION: 'CLOSEPAGE',
                                                PARAM: {
                                                    INDEX: index
                                                }
                                            });
                                        }else {
                                            if(!pageData.indexUrl){
                                                NativeFunc({
                                                    ACTION: "OPENURL",
                                                    PARAM: {
                                                        URL: pageData.requestUrl +"/index.html?noFirst=1&forbidden=1"
                                                    }
                                                })
                                            }else{
                                                NativeFunc({
                                                    ACTION: "OPENURL",
                                                    PARAM: {
                                                        URL: pageData.indexUrl + "&noFirst=1"
                                                    }
                                                })
                                            }
                                        }
                                    });
                                    //查看订单
                                    $(document).on('click', '#orderDetail', function () {
                                        //是否是商城
                                        var detailParam;
                                        if(/healthcloud-shop-h5/.test(firstData.data.orderItemUrl)){
                                            detailParam="orderId";
                                        }else{
                                            detailParam="pay_code";
                                        }
                                        NativeFunc({
                                            ACTION: "OPENURL",
                                            PARAM: {
                                                URL: firstData.data.orderItemUrl+"?"+detailParam+"=" + localStorage.getItem(detailParam)+"&v="+new Date().getTime()
                                            }
                                        })
                                    });
                                },1500)
                            } else if ( firstData.data.status == 0) {
                                NativeFunc({
                                    ACTION: "OPENURL",
                                    PARAM: {
                                        URL: pageData.paymentRequestUrl + "/orderPay.html?forPage=2&orderId=" + pageData.orderId + "&paymentNo=" + pageData.paymentNo + "&totalFee=" + pageData.amount
                                    }
                                })
                            }
                            hideMyloading();
                        }else {
                            requestWrongCode(firstData.code, firstData.msg);
                            hideMyloading();
                        }
                    });
                } catch (e) {
                    hideMyloading();
                    showMyTip();
                    console.log(e);
                }
            })
            function getResult() {
                try {
                    custom.ajaxRequest({
                        url: ajaxUrl.payAgentPayNotifyStatus,
                        type: "POST",
                        data: JSON.stringify({"paymentNo": pageData.paymentNo}),
                        error: function (error) {
                            hideMyloading();
                            console.log(error)
                            showMyTip();
                        }
                    }
                    ,function (firstData) {
                        if (firstData.code == 0) {
                            if (firstData.data.status == 1) {
                                $(".popup-wrap").hide();
                                $("#ask").hide();
                                $("#success").show();
                                //跳首页
                                $(document).on('click', '#toIndex', function () {
                                    if(pageData.isNative=='1'){
                                        //回到第一个webview
                                        //是否是商城(配在底部tab)
                                        var index;
                                        if(/healthcloud-shop-h5/.test(firstData.data.orderItemUrl)){
                                            index=-9;
                                        }else{
                                            index=-1;
                                        }
                                        NativeFunc({
                                            ACTION: 'CLOSEPAGE',
                                            PARAM: {
                                                INDEX: index
                                            }
                                        });
                                    }else {
                                        if(!pageData.indexUrl){
                                            NativeFunc({
                                                ACTION: "OPENURL",
                                                PARAM: {
                                                    URL: pageData.requestUrl +"/index.html?noFirst=1&forbidden=1"
                                                }
                                            })
                                        }else{
                                            NativeFunc({
                                                ACTION: "OPENURL",
                                                PARAM: {
                                                    URL: pageData.indexUrl + "&noFirst=1"
                                                }
                                            })
                                        }
                                    }
                                });
                                //查看订单
                                $(document).on('click', '#orderDetail', function () {
                                    //是否是商城
                                    var detailParam;
                                    if(/healthcloud-shop-h5/.test(firstData.data.orderItemUrl)){
                                        detailParam="orderId";
                                    }else{
                                        detailParam="pay_code";
                                    }
                                    // 延迟跳转订单页面 防止由于网络延时导致后台未更新订单状态
                                    showMyloading();
                                    setTimeout(function() {
                                        hideMyloading();
                                        NativeFunc({
                                            ACTION: "OPENURL",
                                            PARAM: {
                                                URL: firstData.data.orderItemUrl+"?"+detailParam+"=" + localStorage.getItem(detailParam)+"&v="+new Date().getTime()
                                            }
                                        })
                                    }, 2500);
                                });
                            } else if ( firstData.data.status == 0||firstData.data.status == 2) {
                                $(".popup-wrap").hide();
                                $("#ask").hide();
                                $("#fail").show();
                                //重新支付
                                $(document).on('click', '.repay', function () {
                                    NativeFunc({
                                        ACTION: "OPENURL",
                                        PARAM: {
                                            URL: pageData.paymentRequestUrl + "/orderPay.html?forPage=2&orderId=" + pageData.orderId + "&paymentNo=" + pageData.paymentNo + "&totalFee=" + pageData.amount
                                        }
                                    })
                                });
                            }
                        }else {
                            requestWrongCode(firstData.code, firstData.msg);
                        }
                        hideMyloading();
                    });
                } catch (e) {
                    hideMyloading();
                    showMyTip();
                    console.log(e);
                }
            }
        })  
    </script>

</body>

</html>